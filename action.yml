name: 'CD'
description: 'Clone the user of the dependency, change its build.zig.zon and make a PR'
inputs:
  user:
    description: 'User of the dependency'
    required: true
runs:
  using: "composite"
  steps:
    - uses: actions/checkout@v4
    - uses: tiawl/spaceporn-dep-action-env@v1

    - name: Setup Zig
      uses: goto-bus-stop/setup-zig@v2.2.0
      with:
        version: ${{ env.zig_version }}

    - name: Set variables
      id: vars
      shell: ${{ env.shell }}
      run: |
        printf 'tmp=%s\n' "$(mktemp -d)" >> "${GITHUB_OUTPUT}"
        printf 'hash=%s\n' "$(zig fetch .)" >> "${GITHUB_OUTPUT}"

    - name: Clone ${{ inputs.user }}
      shell: ${{ env.shell }}
      run: |
        git clone --recurse-submodules "${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY_OWNER}/${{ inputs.user }}.git" "${{ steps.vars.outputs.tmp }}"

    - name: Setup git user information
      working-directory: ${{ steps.vars.outputs.tmp }}
      shell: ${{ env.shell }}
      run: |
        git config user.name "${{ env.gh_bot_name }}"
        git config user.email "${{ env.gh_bot_email }}"
        git checkout -b "${{ env.bot_branch }}"

    - name: Update ${{ inputs.user }}/build.zig.zon
      working-directory: ${{ steps.vars.outputs.tmp }}
      shell: ${{ env.shell }}
      run: |
        zon_url="$(grep -o "${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/archive/.*\.tar\.gz" build.zig.zon)"
        zon_hash="$(zig fetch "${zon_url}")"
        sed -i "s@${zon_url}@${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/archive/refs/tags/${GITHUB_REF_NAME}.tar.gz@;
                s@${zon_hash}@${{ steps.vars.outputs.hash }}@" build.zig.zon

    - name: Create Pull Request
      working-directory: ${{ steps.vars.outputs.tmp }}
      shell: ${{ env.shell }}
      run: |
        git add -A
        git commit -m "CD: ${{ env.gh_bot_pr_title }}"
        git push --force --set-upstream origin "${{ env.bot_branch }}"
        gh pr create --base "${{ env.default_branch }}" --fill --label "${{ env.gh_bot_label }}" --reviewer "${GITHUB_REPOSITORY_OWNER}"
      env:
        GH_TOKEN: ${{ github.token }}
